// Database Schema
// This is your Prisma schema file for the main database

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client-bd"
}

datasource db {
  provider = "postgresql" // Change to "mysql" or "sqlite" if needed
  url      = env("DATABASE_URL")
}

model Document {
  id                Int       @id @default(autoincrement())
  documentId       Int       @unique @map("document_id")
  fileId           String?   @map("file_id")
  photoType        String?   @map("photo_type")
  photoTypeOCR    String?   @map("photo_type_ocr")
  errors            String?   @map("errors")
  extracted         Boolean   @default(false) @map("extracted")
  validated         Boolean   @default(false) @map("validated")
  createdAt        DateTime  @default(now()) @map("created_at")
  status            String    @map("status")
  captureStartDate DateTime? @map("capture_start_date")
  captureEndDate  DateTime? @map("capture_end_date")
  documentUrl      String?   @map("document_url")
  mayaDocumentJSON String?  @map("maya_document_json")
  tapDocumentJSON String?   @map("tap_document_json")
  path              String?   @map("path")

  // Manual validation assignment tracking
  assignedUserId  Int?      @map("assigned_user_id")
  assignedAt       DateTime? @map("assigned_at")
  completedAt      DateTime? @map("completed_at")

  fields            Field[]
  assignedUser      User?     @relation(fields: [assignedUserId], references: [id])

  @@index([assignedUserId])
  @@map("document")
}

model Field {
  id          Int       @id @default(autoincrement())
  documentId Int       @map("document_id")
  row         Int?      @db.SmallInt @map("row")
  name        String    @map("name")
  value       String?   @map("value")
  confidence  Decimal?  @db.Decimal(5, 2) @map("confidence")
  type        String    @map("type")
  extracted   Boolean   @default(false) @map("extracted")
  validated   Boolean   @default(false) @map("validated")
  createdAt  DateTime  @default(now()) @map("created_at")

  document    Document  @relation(fields: [documentId], references: [documentId], onDelete: Cascade)
  @@map("field")

}

// Meiko Delivery Tables (Mirror of Meiko DB in our database)
model MeikoDocument {
  id                     Int           @id @default(autoincrement())
  surveyRecordId       BigInt        @map("survey_record_id")
  responseId            BigInt?       @map("response_id")
  stickerQr             String?       @db.VarChar(50) @map("sticker_qr")
  responseReceived      String?       @db.VarChar(100) @map("response_received")
  variableName          String?       @db.VarChar(255) @map("variable_name")
  photoType             String?       @db.VarChar(255) @map("photo_type")
  link                   String?       @db.Text @map("link")
  flagDigitalization    Int?          @db.SmallInt @map("flag_digitalization")
  digitalizationDate    DateTime?     @map("digitalization_date")
  extractionDate        DateTime?     @map("extraction_date")

  // Additional tracking fields
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")
  deliveryStatus        String        @default("PENDING") @map("delivery_status") // PENDING, DELIVERED, ERROR

  // Relations
  results                MeikoResult[]

  @@unique([surveyRecordId, variableName])
  @@index([stickerQr])
  @@index([photoType])
  @@index([responseId])
  @@map("meiko_document")
}

model MeikoResult {
  id                      Int          @id @default(autoincrement())
  meikoDocumentId       Int          @map("meiko_document_id")
  surveyRecordId        Int          @map("survey_record_id")
  documentNumber         String?      @db.VarChar(11) @map("document_number")
  documentDate           DateTime?    @map("document_date")
  businessName           String?      @db.Text @map("business_name")
  productCode            String?      @db.VarChar(111) @map("product_code")
  description             String?      @db.VarChar(500) @map("description")
  packagingType          String?      @db.VarChar(255) @map("packaging_type")
  packagingUnit          Decimal?     @db.Decimal(11, 2) @map("packaging_unit")
  packsSold              Decimal?     @db.Decimal(11, 2) @map("packs_sold")
  saleValue              Decimal?     @db.Decimal(10, 0) @map("sale_value")
  unitsSold              Decimal?     @db.Decimal(11, 2) @map("units_sold")
  totalDocument          Decimal?     @db.Decimal(11, 2) @map("total_document")
  totalDocumentWithoutVat Decimal?  @db.Decimal(11, 2) @map("total_document_without_vat")
  rowNumber              Int          @map("row_number")
  valueIbuaAndOthers   Int?         @map("value_ibua_and_others")

  // Additional tracking fields
  createdAt              DateTime     @default(now()) @map("created_at")
  confidence              Decimal?     @db.Decimal(5, 2) @map("confidence")

  // Relations
  meikoDocument           MeikoDocument @relation(fields: [meikoDocumentId], references: [id], onDelete: Cascade)

  @@unique([meikoDocumentId, rowNumber])
  @@index([surveyRecordId])
  @@index([documentNumber])
  @@index([description])
  @@index([documentDate])
  @@map("meiko_result")
}


// User Model for Authentication
model User {
  id               Int       @id @default(autoincrement())
  email            String    @unique @map("email")
  password         String    @map("password")
  name             String?   @map("name")
  role             String    @default("user") @map("role")
  active           Boolean   @default(true) @map("active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  assignedDocuments Document[]

  @@map("user")
}


model ExcludedProducts {
  id                Int     @id @default(autoincrement())
  description       String? @db.VarChar(500) @map("description")

  @@map("excluded_products")
}
