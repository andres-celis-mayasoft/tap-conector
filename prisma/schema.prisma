// Database Schema
// This is your Prisma schema file for the main database

generator client {
  provider = "prisma-client-js"
  output   = "generated/client"
}

datasource db {
  provider = "postgresql" // Change to "mysql" or "sqlite" if needed
  url      = env("DATABASE_URL")
}

model Document {
  id                Int       @id @default(autoincrement())
  documentId       Int       @unique @map("document_id")
  surveyId           String?   @map("survey_id")
  photoType        String   @map("photo_type")
  photoTypeOCR    String?   @map("photo_type_ocr")
  errors            String?   @map("errors")
  extracted         Boolean   @default(false) @map("extracted")
  validated         Boolean   @default(false) @map("validated")
  createdAt        DateTime  @default(now()) @map("created_at")
  status            String    @map("status")
  deliveryStatus    String?    @map("delivery_status")
  captureStartDate DateTime? @map("capture_start_date")
  captureEndDate  DateTime? @map("capture_end_date")
  documentUrl      String?   @map("document_url")
  mayaDocumentJSON String?  @map("maya_document_json")
  path              String?   @map("path")

  // Manual validation assignment tracking
  assignedUserId  Int?      @map("assigned_user_id")
  assignedAt       DateTime? @map("assigned_at")
  completedAt      DateTime? @map("completed_at")

  fields            Field[]
  assignedUser      User?     @relation(fields: [assignedUserId], references: [id])


  // OJO ESTO ES SOLO PARA TESTING
  results                MeikoResult[]

  @@index([assignedUserId])
  @@map("document")
}

model Field {
  id          Int       @id @default(autoincrement())
  documentId Int       @map("document_id")
  row         Int?      @db.SmallInt @map("row")
  name        String    @map("name")
  value       String?   @map("value")
  corrected_value       String?   @map("corrected_value")
  confidence  Decimal?  @db.Decimal(5, 2) @map("confidence")
  type        String    @map("type")
  extracted   Boolean   @default(false) @map("extracted")
  validated   Boolean   @default(false) @map("validated")
  createdAt  DateTime  @default(now()) @map("created_at")

  document    Document  @relation(fields: [documentId], references: [documentId], onDelete: Cascade)
  @@map("field")

}

// User Model for Authentication
model User {
  id               Int       @id @default(autoincrement())
  email            String    @unique @map("email")
  password         String    @map("password")
  name             String?   @map("name")
  role             String    @default("user") @map("role")
  active           Boolean   @default(true) @map("active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  assignedDocuments Document[]

  @@map("user")
}


model ExcludedProducts {
  id                Int     @id @default(autoincrement())
  description       String? @db.VarChar(500) @map("description")

  @@map("excluded_products")
}




// Meiko Delivery Tables (Mirror of Meiko DB in our database)
model MeikoDocument {
  id                     Int           @id @default(autoincrement()) @map("id_factura")
  surveyRecordId       BigInt        @map("idRegistroEncuesta")
  responseId            BigInt?       @map("responseId")
  stickerQr             String?       @db.VarChar(50) @map("stickerQR")
  responseReceived      String?       @db.VarChar(100) @map("responseReceived")
  variableName          String?       @db.VarChar(255) @map("nombre_variable")
  photoType             String?       @db.VarChar(255) @map("tipo_foto")
  link                   String?       @db.Text @map("link")
  flagDigitalization    Int?          @db.SmallInt @map("flag_digitalizacion")
  digitalizationDate    DateTime?     @map("fecha_digitalizacion")
  extractionDate        DateTime?     @map("fechaExtraccion")

  // Additional tracking fields
  //createdAt             DateTime      @default(now()) @map("created_at")
  //updatedAt             DateTime      @updatedAt @map("updated_at")
  //deliveryStatus        String        @default("PENDING") @map("delivery_status") // PENDING, DELIVERED, ERROR

  // Relations
  // OJO ESTO ES SOLO PARA TESTING
  // results                MeikoResult[]

  @@unique([surveyRecordId, variableName])
  @@index([stickerQr])
  @@index([photoType])
  @@index([responseId])
  @@map("factura")
}

model MeikoResult {
  id                     Int          @id @default(autoincrement()) @map("id_detalle_factura")
  invoiceId              Int          @map("id_factura")
  surveyRecordId         Int          @map("idRegistroEncuesta")
  invoiceNumber          String?      @db.VarChar(11) @map("numero_factura")
  documentDate           DateTime?    @map("fecha_factura")
  businessName           String?      @db.Text @map("razon_social")
  productCode            String?      @db.VarChar(111) @map("codigoProducto")
  description            String?      @db.VarChar(500) @map("descripcion")
  packagingType          String?      @db.VarChar(255) @map("tipo_embalage")
  packagingUnit          Decimal?     @db.Decimal(11, 2) @map("unidad_embalage")
  packsSold              Decimal?     @db.Decimal(11, 2) @map("packs_vendidos")
  saleValue              Decimal?     @db.Decimal(10, 0) @map("valor_venta")
  unitsSold              Decimal?     @db.Decimal(11, 2) @map("unidades_vendidas")
  totalDocument          Decimal?     @db.Decimal(11, 2) @map("total_factura")
  totalDocumentWithoutIVA Decimal?  @db.Decimal(11, 2) @map("total_factura_sin_iva")
  rowNumber              Int          @map("numeroFila")
  valueIbuaAndOthers   Int?         @map("VALOR_IBUA_Y_OTROS")


  // Relations
  // OJO ESTO ES SOLO PARA TESTING
  meikoDocument           Document @relation(fields: [invoiceId], references: [documentId], onDelete: Cascade)

  @@unique([invoiceId, rowNumber])
  @@index([surveyRecordId])
  @@index([invoiceNumber])
  @@index([description])
  @@index([documentDate])
  @@map("resultado_digitalizacion")
}

model EstadoDigitalizacionFactura {
  id                      Int            @id @default(autoincrement())
  invoiceId               Int            @unique @map("id_factura")
  digitalizationStatusId  Int            @map("estado_digitalizacion_id")

  @@map("estado_digitalizacion_factura")
}

model Company {
  id              Int       @id @default(autoincrement())
  legalName     String    @db.VarChar(255) @map("legal_name")

  products       Product[]
  excluded       Excluded[]
  @@map("company")
}
model Product {
  id Int                 @id @default(autoincrement())
  description    String    @db.VarChar(500)
  code           String    @db.VarChar(50)
  packagingUnit  String?   @db.VarChar(50) @map("packaging_unit")
  packagingType  String?   @db.VarChar(50) @map("packaging_type")

  companyId      Int       @map("company_id")
  company        Company   @relation(fields: [companyId], references: [id])
  @@map("product")
}

model Excluded {
  id Int                 @id @default(autoincrement())
  description String    @db.VarChar(500)
  code        String    @db.VarChar(50)

  companyId      Int       @map("company_id")
  company        Company   @relation(fields: [companyId], references: [id])
  @@map("excluded")
}

