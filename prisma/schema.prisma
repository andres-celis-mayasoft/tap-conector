// Database Schema
// This is your Prisma schema file for the main database

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client-bd"
}

datasource db {
  provider = "postgresql" // Change to "mysql" or "sqlite" if needed
  url      = env("DATABASE_URL")
}

model Invoice {
  id                Int       @id @default(autoincrement())
  invoiceId         Int       @unique
  fileId            String?
  photoType         String?
  photoTypeOcr      String?
  errors            String?
  extracted         Boolean   @default(false)
  validated         Boolean   @default(false)
  date              DateTime  @default(now())
  status            String
  captureStartDate  DateTime?
  captureEndDate    DateTime?
  invoiceUrl        String?
  mayaInvoiceJson   String?
  tapInvoiceJson    String?
  path              String?

  // Manual validation assignment tracking
  assignedUserId    Int?
  assignedAt        DateTime?
  completedAt       DateTime?

  fields            Field[]
  assignedUser      User?     @relation(fields: [assignedUserId], references: [id])

  @@index([assignedUserId])
  @@map("invoice")
}

model Field {
  id         Int       @id @default(autoincrement())
  invoiceId  Int
  row        Int?      @db.SmallInt
  name       String
  value      String?
  confidence Decimal?  @db.Decimal(5, 2)
  type       String
  extracted  Boolean   @default(false)
  validated  Boolean   @default(false)
  date       DateTime  @default(now())

  invoice    Invoice   @relation(fields: [invoiceId], references: [invoiceId])
  @@map("field")

}

// Meiko Delivery Tables (Mirror of Meiko DB in our database)
model MeikoInvoice {
  id                   Int        @id @default(autoincrement())
  surveyRecordId       BigInt
  responseId           BigInt?
  stickerQR            String?    @db.VarChar(50)
  responseReceived     String?    @db.VarChar(100)
  variableName         String?    @db.VarChar(255)
  photoType            String?    @db.VarChar(255)
  link                 String?    @db.Text
  flagDigitalization   Int?       @db.SmallInt
  digitalizationDate   DateTime?
  extractionDate       DateTime?

  // Additional tracking fields
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
  deliveryStatus       String     @default("PENDING") // PENDING, DELIVERED, ERROR

  // Relations
  results              MeikoResult[]

  @@unique([surveyRecordId, variableName])
  @@index([stickerQR])
  @@index([photoType])
  @@index([responseId])
  @@map("meiko_invoice")
}

model MeikoResult {
  id                     Int       @id @default(autoincrement())
  meikoInvoiceId         Int
  surveyRecordId         Int
  invoiceNumber          String?   @db.VarChar(11)
  invoiceDate            DateTime?
  businessName           String?   @db.Text
  productCode            String?   @db.VarChar(111)
  description            String?   @db.VarChar(500)
  packagingType          String?   @db.VarChar(255)
  packagingUnit          Decimal?  @db.Decimal(11, 2)
  packsSold              Decimal?  @db.Decimal(11, 2)
  saleValue              Decimal?  @db.Decimal(10, 0)
  unitsSold              Decimal?  @db.Decimal(11, 2)
  totalInvoice           Decimal?  @db.Decimal(11, 2)
  totalInvoiceWithoutVAT Decimal?  @db.Decimal(11, 2)
  rowNumber              Int
  valueIbuaAndOthers     Int?

  // Additional tracking fields
  createdAt              DateTime  @default(now())
  confidence             Decimal?  @db.Decimal(5, 2)

  // Relations
  meikoInvoice           MeikoInvoice @relation(fields: [meikoInvoiceId], references: [id], onDelete: Cascade)

  @@unique([meikoInvoiceId, rowNumber])
  @@index([surveyRecordId])
  @@index([invoiceNumber])
  @@index([description])
  @@index([invoiceDate])
  @@map("meiko_result")
}


// User Model for Authentication
model User {
  id               Int       @id @default(autoincrement())
  email            String    @unique
  password         String
  name             String?
  role             String    @default("user")
  active           Boolean   @default(true)
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  assignedInvoices Invoice[]

  @@map("user")
}


model ExcludedProducts {
  id               Int       @id @default(autoincrement())
  description            String?   @db.VarChar(500)

  @@map("excluded_products")
}
