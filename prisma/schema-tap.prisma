// TAP Database Schema
// This is your Prisma schema file for the TAP SQL Server database

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client-tap"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_TAP_URL")
}

// Control Proceso Model
model ControlProceso {
  id                   BigInt  @id @default(autoincrement())
  idFactura            BigInt?
  idRegistroEncuesta   BigInt?
  responseId           BigInt?
  stickerQr            String? @db.VarChar(255)
  nombre               String? @db.VarChar(255)
  tipo                 String? @db.VarChar(100)
  link                 String? @db.VarChar(500)
  loteId               BigInt?
  expedienteId         BigInt?
  estado               String? @db.VarChar(50)

  @@map("control_proceso")
  @@index([idFactura])
  @@index([loteId])
  @@index([idFactura, loteId])
}

// Extraction Batch Model
model ExtractionBatch {
  id        Int       @id @default(autoincrement())
  batchId   String    @unique @map("lote_id") @db.NVarChar(100)
  date      DateTime  @default(now()) @map("fecha")

  invoices  ExtractionInvoice[]

  @@map("extraccion_lote")
}

// Extraction Invoice Model
model ExtractionInvoice {
  id           Int       @id @default(autoincrement())
  batchId      Int       @map("lote_id")
  invoiceId    String    @map("factura_id") @db.NVarChar(100)
  docketId     String?   @map("expediente_id") @db.NVarChar(100)
  photoType    String?   @map("tipo_foto") @db.NVarChar(32)
  errors       String?   @map("errores") @db.NVarChar(Max)
  extracted    Boolean   @default(false)
  validated    Boolean   @default(false)
  date         DateTime  @default(now()) @map("fecha")
  photoTypeOcr String?   @map("tipo_foto_ocr") @db.NVarChar(32)

  batch  ExtractionBatch  @relation(fields: [batchId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  fields ExtractionField[]

  @@map("extraccion_factura")
  @@index([batchId])
}

// Extraction Field Model
model ExtractionField {
  id         Int       @id @default(autoincrement())
  invoiceId  Int       @map("factura_id")
  row        Int?      @map("fila") @db.SmallInt
  name       String    @map("nombre") @db.NVarChar(100)
  value      String?   @map("valor") @db.NVarChar(Max)
  confidence Decimal?  @map("confianza") @db.Decimal(5, 2)
  type       String    @map("tipo") @db.NVarChar(20)
  extracted  Boolean   @default(false)
  validated  Boolean   @default(false)
  date       DateTime  @default(now()) @map("fecha")

  invoice ExtractionInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("extraccion_campo")
  @@index([invoiceId])
}


model ExtractionInvoiceMaya {
  id              Int       @id @default(autoincrement())
  invoiceId       Int       @unique @map("factura_id")
  docketId        String?   @map("expediente_id") @db.NVarChar(100)
  photoType       String?   @map("tipo_foto") @db.NVarChar(50)
  photoTypeOcr    String?   @map("tipo_foto_ocr") @db.NVarChar(50)
  errors          String?   @map("errores") @db.NVarChar(4000)
  extracted       Boolean   @default(false)
  validated       Boolean   @default(false)
  date            DateTime  @default(now()) @map("fecha")
  status          String?   @map("estado") @db.NVarChar(50)
  captureStartDate DateTime? @map("fecha_en_captura")
  captureEndDate  DateTime? @map("fecha_capturado")
  invoiceUrl      String?   @map("url_factura") @db.NVarChar(4000)
  mayaInvoiceJson String?   @map("json_invoice_maya") @db.NVarChar(4000)
  tapInvoiceJson  String?   @map("json_invoice_tap") @db.NVarChar(4000)
  userId          String?   @map("user_id") @db.NVarChar(100)

  @@map("extraccion_factura_maya")
  @@index([status], map: "IX_factura_maya_estado")
  @@index([extracted, validated], map: "IX_factura_maya_extracted_validated")
  @@index([date], map: "IX_factura_maya_fecha")
  @@index([photoType], map: "IX_factura_maya_tipo_foto")
  @@index([photoTypeOcr], map: "IX_factura_maya_tipo_foto_ocr")
}